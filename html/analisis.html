<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>An√°lisis Semanal - Horus</title>
  <link rel="stylesheet" href="../css/style.css" />
  <!-- Carga LOCAL de librer√≠as -->
  <script src="../js/PapaParse.js"></script>
  <script src="../js/chart.js"></script>
</head>
<body class="light-mode">
  <nav class="nav">
    <div class="nav-container">
      <div class="nav-buttons">
        <a href="../index.html" class="nav-btn">Inicio</a>
        <a href="mqtt.html" class="nav-btn">Datos en Vivo</a>
        <a href="analisis.html" class="nav-btn active">An√°lisis</a>
      </div>
      <div class="nav-right">
        <label class="theme-switch">
          <input type="checkbox" class="theme-switch__checkbox">
          <div class="theme-switch__container">
            <div class="theme-switch__clouds"></div>
            <div class="theme-switch__stars-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none">
                <!-- ... SVG del switch ... -->
              </svg>
            </div>
            <div class="theme-switch__circle-container">
              <div class="theme-switch__sun-moon-container">
                <div class="theme-switch__moon">
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                </div>
              </div>
            </div>
          </div>
        </label>
      </div>
    </div>
  </nav>

  <div class="container">
    <header>
      <h1>üìä An√°lisis Semanal de Datos</h1>
      <p>√öltimos 7 d√≠as de mediciones de la estaci√≥n Horus</p>
    </header>

    <main id="charts-container">
      <div class="chart-wrapper-full">
        <canvas id="tempChart"></canvas>
      </div>
      <div class="chart-wrapper-full">
        <canvas id="humChart"></canvas>
      </div>
      <div class="chart-wrapper-full">
        <canvas id="pressChart"></canvas>
      </div>
      <div class="chart-wrapper-full">
        <canvas id="pm25Chart"></canvas>
      </div>
      <div class="chart-wrapper-full">
        <canvas id="windChart"></canvas>
      </div>
      <div class="chart-wrapper-full">
        <canvas id="rainChart"></canvas>
      </div>
    </main>
  </div>

  <!-- Script de an√°lisis -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      console.log("üìä Cargando datos...");

      // Tu enlace CSV
      const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWCl1SexRqaXBFHYwWMLz2NjeZ0JlHmSRa2Ia_XUz974vGK8a74QgBqfhZRGxKkEzDGn1JdD1sDLpq/pub?gid=0&single=true&output=csv";

      // Verifica que las librer√≠as est√©n cargadas
      if (typeof Papa === 'undefined') {
        console.error("‚ùå ERROR: PapaParse.js no se carg√≥.");
        return;
      }
      if (typeof Chart === 'undefined') {
        console.error("‚ùå ERROR: chart.js no se carg√≥.");
        return;
      }

      Papa.parse(sheetURL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          if (data.length <= 1) {
            console.warn("‚ö†Ô∏è No hay datos para mostrar.");
            return;
          }

          // Filtrar √∫ltima semana
          const oneWeekAgo = new Date();
          oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

          const lastWeekData = data
            .filter(row => row.fecha && !isNaN(new Date(row.fecha)))
            .map(row => ({ ...row, fecha: row.fecha.split(' ')[0] }))
            .filter(row => new Date(row.fecha) >= oneWeekAgo);

          if (lastWeekData.length === 0) {
            console.warn("‚ö†Ô∏è No hay datos de la √∫ltima semana.");
            return;
          }

          // Crea gr√°ficas
          createChart('tempChart', 'Temperatura (¬∞C)', lastWeekData, 'temperatura', '#FF6384');
          createChart('humChart', 'Humedad (%)', lastWeekData, 'humedad', '#36A2EB');
          createChart('pressChart', 'Presi√≥n (hPa)', lastWeekData, 'presion', '#FFCE56');
          createChart('pm25Chart', 'PM2.5 (¬µg/m¬≥)', lastWeekData, 'pm25', '#4BC0C0');
          createChart('windChart', 'Viento (km/h)', lastWeekData, 'windSpeed', '#C9CBCF');
          createChart('rainChart', 'Lluvia (mm)', lastWeekData, 'lluvia', '#46BFBD');
        },
        error: function(error) {
          console.error("‚ùå Error al cargar CSV:", error);
        }
      });

      function createChart(canvasId, label, data, field, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.fecha),
            datasets: [{
              label: label,
              data: data.map(d => parseFloat(d[field]) || null),
              borderColor: color,
              backgroundColor: color + '40',
              borderWidth: 3,
              tension: 0.3,
              pointRadius: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { title: { display: true, text: 'Fecha' } },
              y: { beginAtZero: false, title: { display: true, text: label } }
            }
          }
        });
      }

      // === Modo claro/oscuro ===
      const body = document.body;
      const checkbox = document.querySelector(".theme-switch__checkbox");
      const isDark = localStorage.getItem("darkMode") === "true";
      body.classList.toggle("dark-mode", isDark);
      if (checkbox) checkbox.checked = isDark;

      if (checkbox) {
        checkbox.addEventListener("change", (e) => {
          body.classList.toggle("dark-mode", e.target.checked);
          localStorage.setItem("darkMode", e.target.checked);
        });
      }
    });
  </script>
</body>
</html>
